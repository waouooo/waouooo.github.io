<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.7"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="Golang golang 相关内容"><meta name=author content="waouooo"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://waouooo.github.io/images/hero.png"><meta name=twitter:title content="Golang :: waouooo"><meta name=twitter:description content="Golang golang 相关内容"><meta property="og:url" content="https://waouooo.github.io/go-230210/index.html"><meta property="og:site_name" content="waouooo"><meta property="og:title" content="Golang :: waouooo"><meta property="og:description" content="Golang golang 相关内容"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://waouooo.github.io/images/hero.png"><meta itemprop=name content="Golang :: waouooo"><meta itemprop=description content="Golang golang 相关内容"><meta itemprop=dateModified content="2023-02-10T17:15:20+08:00"><meta itemprop=wordCount content="6"><meta itemprop=image content="https://waouooo.github.io/images/hero.png"><title>Golang :: waouooo</title>
<link href=https://waouooo.github.io/go-230210/index.html rel=canonical type=text/html title="Golang :: waouooo"><link href=../go-230210/index.xml rel=alternate type=application/rss+xml title="Golang :: waouooo"><link href=../images/favicon.png?1715187311 rel=icon type=image/png><link href=../css/fontawesome-all.min.css?1715187312 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1715187312 rel=stylesheet></noscript><link href=../css/nucleus.css?1715187312 rel=stylesheet><link href=../css/auto-complete.css?1715187312 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1715187312 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1715187312 rel=stylesheet><link href=../css/fonts.css?1715187312 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1715187312 rel=stylesheet></noscript><link href=../css/theme.css?1715187312 rel=stylesheet><link href=../css/theme-relearn-auto.css?1715187312 rel=stylesheet id=R-variant-style><link href=../css/chroma-relearn-auto.css?1715187312 rel=stylesheet id=R-variant-chroma-style><link href=../css/variant.css?1715187312 rel=stylesheet><link href=../css/print.css?1715187312 rel=stylesheet media=print><link href=../css/format-print.css?1715187312 rel=stylesheet><script src=../js/variant.js?1715187312></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://waouooo.github.io",window.index_js_url="../index.search.js",window.variants&&variants.init(["relearn-auto","relearn-light","relearn-dark","relearn-bright","zen-auto","zen-light","zen-dark","retro-auto","neon","learn","blue","green","red"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../go-230210/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Golang</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../index.html title="waouooo (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../go-230210/time-tick-oom/index.html title="time.Tick() 内存泄漏问题排查 (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 1</div><h1 id=golang>Golang</h1><h3 id=golang>Golang</h3><p>golang 相关内容</p><footer class=footline><div><style>#comment{padding:8rem 0 2rem}#comment .vemoji{max-width:1.5em;max-height:1.5em}</style><div id=comment><script src=https://giscus.app/client.js data-repo=waouooo/discussions data-repo-id=R_kgDOI-EgHQ data-category=General data-category-id=DIC_kwDOI-EgHc4CUORS data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><noscript>Please enable JavaScript to view the comments powered by giscus.</noscript></div></footer></article><section><h1 class=a11y-only>Subsections of Golang</h1><article class=default><header class=headline><div class="taxonomy-tags term-list cstyle tags" title=Tags style=--VARIABLE-TAGS-BG-color:var(--INTERNAL-TAG-BG-color)><ul><li><a class=term-link href=../tags/golang/index.html>Golang</a></li><li><a class=term-link href=../tags/memory-leak/index.html>Memory Leak</a></li><li><a class=term-link href=../tags/oom/index.html>OOM</a></li><li><a class=term-link href=../tags/time/index.html>Time</a></li><li><a class=term-link href=../tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/index.html>内存泄漏</a></li></ul></div></header><h1 id=timetick-内存泄漏问题排查>time.Tick() 内存泄漏问题排查</h1><h3 id=背景>背景：</h3><p>目前我们开发的流水线服务（pipeline）任务状态流转主要依赖drone-server往pipeline中推送，推送过程涉及drone-server -> webhook , webhook -> pipeline 两个过程，因为网络不完全可靠，因此会出现偶尔的状态丢失问题。现在通过pipeline 中定时向drone-server中查询build状态来弥补部分状态丢失问题。当任务开发完成投入预发环境运行时，观察监控发现: pipeline服务长时间运行后会出现cpu和内存缓慢增长的问题。</p><p>监控图表📈：</p><p>cpu:
<a href=#R-image-50a776e417378761b0d5309b8e0b8037 class=lightbox-link><img alt=cpu class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171804.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-50a776e417378761b0d5309b8e0b8037><img alt=cpu class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171804.png></a>
mem:
<a href=#R-image-75faa02fba007a957fffa78d2e24d1bc class=lightbox-link><img alt=mem class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171736.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-75faa02fba007a957fffa78d2e24d1bc><img alt=mem class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171736.png></a></p><h3 id=问题排查>问题排查</h3><ol><li>使用pprof 观察</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pipeline  go tool pprof https://xxx.com/debug/pprof/heap
</span></span><span class=line><span class=cl>Fetching profile over HTTP from https://xxx.com/debug/pprof/heap
</span></span><span class=line><span class=cl>Saved profile in /Users/zhou/pprof/pprof.pipeline.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz
</span></span><span class=line><span class=cl>File: pipeline
</span></span><span class=line><span class=cl>Build ID: f5b549d19b3a22503c2410c78834ba394de7cfa6
</span></span><span class=line><span class=cl>Type: inuse_space
</span></span><span class=line><span class=cl>Time: Nov 22, <span class=m>2022</span> at 9:11am <span class=o>(</span>CST<span class=o>)</span>
</span></span><span class=line><span class=cl>Entering interactive mode <span class=o>(</span><span class=nb>type</span> <span class=s2>&#34;help&#34;</span> <span class=k>for</span> commands, <span class=s2>&#34;o&#34;</span> <span class=k>for</span> options<span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=o>(</span>pprof<span class=o>)</span> top
</span></span><span class=line><span class=cl>Showing nodes accounting <span class=k>for</span> 17358.76kB, 91.86% of 18897kB total
</span></span><span class=line><span class=cl>Showing top <span class=m>10</span> nodes out of <span class=m>125</span>
</span></span><span class=line><span class=cl>      flat  flat%   sum%        cum   cum%
</span></span><span class=line><span class=cl> 8192.69kB 43.35% 43.35%  8192.69kB 43.35%  time.NewTicker
</span></span><span class=line><span class=cl> 2802.47kB 14.83% 58.18%  2802.47kB 14.83% ******/pipeline/vendor/github.com/klauspost/compress/zstd.encoderOptions.encoder
</span></span><span class=line><span class=cl> 1805.17kB  9.55% 67.74%  1805.17kB  9.55%  compress/flate.NewWriter
</span></span><span class=line><span class=cl> 1025.80kB  5.43% 73.17%  1543.13kB  8.17%  ******/pipeline/vendor/google.golang.org/protobuf/internal/filedesc.<span class=o>(</span>*Message<span class=o>)</span>.unmarshalFull
</span></span><span class=line><span class=cl>  768.26kB  4.07% 77.23%   768.26kB  4.07%  syscall.copyenv
</span></span><span class=line><span class=cl>  613.99kB  3.25% 80.48%   613.99kB  3.25%  bytes.makeSlice
</span></span><span class=line><span class=cl>  578.66kB  3.06% 83.54%   578.66kB  3.06%  ******/pipeline/vendor/github.com/klauspost/compress/zstd.<span class=o>(</span>*blockEnc<span class=o>)</span>.init
</span></span><span class=line><span class=cl>  536.37kB  2.84% 86.38%   536.37kB  2.84%  regexp/syntax.<span class=o>(</span>*compiler<span class=o>)</span>.inst
</span></span><span class=line><span class=cl>  518.02kB  2.74% 89.12%   518.02kB  2.74%  ******/pipeline/vendor/github.com/beorn7/perks/quantile.newStream
</span></span><span class=line><span class=cl>  517.33kB  2.74% 91.86%   517.33kB  2.74%  ******/pipeline/vendor/google.golang.org/protobuf/internal/strs.<span class=o>(</span>*Builder<span class=o>)</span>.AppendFullName
</span></span><span class=line><span class=cl><span class=o>(</span>pprof<span class=o>)</span> web</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pipeline  go tool pprof https://xxx.com/debug/pprof/profile<span class=se>\?</span>second<span class=se>\=</span><span class=m>120</span>
</span></span><span class=line><span class=cl>Fetching profile over HTTP from https://xxx.com/debug/pprof/profile?second<span class=o>=</span><span class=m>120</span>
</span></span><span class=line><span class=cl>Saved profile in /Users/zhou/pprof/pprof.pipeline.samples.cpu.001.pb.gz
</span></span><span class=line><span class=cl>File: pipeline
</span></span><span class=line><span class=cl>Build ID: f5b549d19b3a22503c2410c78834ba394de7cfa6
</span></span><span class=line><span class=cl>Type: cpu
</span></span><span class=line><span class=cl>Time: Nov 22, <span class=m>2022</span> at 9:15am <span class=o>(</span>CST<span class=o>)</span>
</span></span><span class=line><span class=cl>Duration: 30.10s, Total <span class=nv>samples</span> <span class=o>=</span> 1.18s <span class=o>(</span> 3.92%<span class=o>)</span>
</span></span><span class=line><span class=cl>Entering interactive mode <span class=o>(</span><span class=nb>type</span> <span class=s2>&#34;help&#34;</span> <span class=k>for</span> commands, <span class=s2>&#34;o&#34;</span> <span class=k>for</span> options<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>(</span>pprof<span class=o>)</span> top
</span></span><span class=line><span class=cl>Showing nodes accounting <span class=k>for</span> 1.13s, 95.76% of 1.18s total
</span></span><span class=line><span class=cl>Showing top <span class=m>10</span> nodes out of <span class=m>28</span>
</span></span><span class=line><span class=cl>      flat  flat%   sum%        cum   cum%
</span></span><span class=line><span class=cl>     0.66s 55.93% 55.93%      0.66s 55.93%  runtime.siftdownTimer
</span></span><span class=line><span class=cl>     0.13s 11.02% 66.95%      0.13s 11.02%  runtime.epollwait
</span></span><span class=line><span class=cl>     0.12s 10.17% 77.12%      0.13s 11.02%  runtime.chansend
</span></span><span class=line><span class=cl>     0.05s  4.24% 81.36%      0.07s  5.93%  runtime.nanotime <span class=o>(</span>inline<span class=o>)</span>
</span></span><span class=line><span class=cl>     0.05s  4.24% 85.59%      0.05s  4.24%  runtime.walltime <span class=o>(</span>inline<span class=o>)</span>
</span></span><span class=line><span class=cl>     0.04s  3.39% 88.98%      1.18s   100%  runtime.findrunnable
</span></span><span class=line><span class=cl>     0.03s  2.54% 91.53%      0.03s  2.54%  runtime.unlock2
</span></span><span class=line><span class=cl>     0.02s  1.69% 93.22%      0.02s  1.69%  runtime.nanotime1
</span></span><span class=line><span class=cl>     0.02s  1.69% 94.92%      0.15s 12.71%  runtime.netpoll
</span></span><span class=line><span class=cl>     0.01s  0.85% 95.76%      0.01s  0.85%  runtime.<span class=o>(</span>*randomEnum<span class=o>)</span>.done <span class=o>(</span>inline<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>(</span>pprof<span class=o>)</span> web</span></span></code></pre></div><ol start=2><li>使用web命令生成svg图片观察更直观：
<a href=#R-image-380dcdb41f28263c8b4d8b6880c3c556 class=lightbox-link><img alt=heap class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123165456.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-380dcdb41f28263c8b4d8b6880c3c556><img alt=heap class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123165456.png></a></li></ol><p><a href=#R-image-906dbe7b76bde59cacc792edae006a2c class=lightbox-link><img alt=cpu class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123165536.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-906dbe7b76bde59cacc792edae006a2c><img alt=cpu class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123165536.png></a></p><p><a href=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/pprof002.svg rel=external target=_self>heap svg</a>
<a href=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/pprof003.svg rel=external target=_self>cpu svg</a></p><ol start=3><li>通过pprof分析可得cpu与heap主要被runtime包中的方法占用了。
其实从heap的性能图中基本可以看出主要是被time.NewTicker给占用了，而新增的代码中只有一处使用了tick进行计时，代码如下：</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>util</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RM</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>Tick</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>            <span class=nx>second</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Second</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>existed</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>second</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>!</span><span class=nx>existed</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>util</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>t</span><span class=p>.</span><span class=nf>readCache</span><span class=p>(</span><span class=nx>second</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=p>})</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>second</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div><ol start=4><li>进入time.Tick方法查看源码如下:</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Tick is a convenience wrapper for NewTicker providing access to the ticking
</span></span></span><span class=line><span class=cl><span class=c1>// channel only. While Tick is useful for clients that have no need to shut down
</span></span></span><span class=line><span class=cl><span class=c1>// the Ticker, be aware that without a way to shut it down the underlying  
</span></span></span><span class=line><span class=cl><span class=c1>// Ticker cannot be recovered by the garbage collector; it &#34;leaks&#34;.
</span></span></span><span class=line><span class=cl><span class=c1>// Unlike NewTicker, Tick will return nil if d &lt;= 0.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Tick</span><span class=p>(</span><span class=nx>d</span> <span class=nx>Duration</span><span class=p>)</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=nx>Time</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>d</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nf>NewTicker</span><span class=p>(</span><span class=nx>d</span><span class=p>).</span><span class=nx>C</span>  
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><blockquote><p>通过代码以及其注释可知，每调用一次Tick() 方法都会生成一个新的Ticker，并且没有办法被关闭,从而无法被gc回收导致内存泄漏。而在业务代码中，在循环调用time.Tick()方法进行倒计时，导致生成了大量的Ticker在内存中，使得应用资源使用率在不断得增加。</p></blockquote><ol start=5><li>代码修改：</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>util</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RM</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=c1>// 在循环开始前初始化一个ticker
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>ticker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ticker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>            <span class=nx>second</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Second</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>existed</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>second</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>!</span><span class=nx>existed</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>util</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>t</span><span class=p>.</span><span class=nf>readCache</span><span class=p>(</span><span class=nx>second</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=p>})</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>second</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>  
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div><pre><code>在循环开始之前生成唯一一个ticker，从而避免使用time.Tick()的包装方法每次都生成新的ticker，因为这个倒计时存在于整个应用运行的生命周期，因此也无需关闭
</code></pre><ol start=6><li>修复后的监控图表📈：</li></ol><p>cpu:
<a href=#R-image-5255ad358ef6ad777e51dfb69329b4aa class=lightbox-link><img alt=cpu class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171650.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5255ad358ef6ad777e51dfb69329b4aa><img alt=cpu class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171650.png></a></p><p>mem:
<a href=#R-image-d171e4b682e6986d38b5fa3d4a6e0ed3 class=lightbox-link><img alt=mem class="bg-white border lazy lightbox noshadow figure-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171712.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d171e4b682e6986d38b5fa3d4a6e0ed3><img alt=mem class="bg-white border lazy lightbox noshadow lightbox-image" loading=lazy src=https://raw.githubusercontent.com/zhou-yi-git/picture-bed/master/images/202208/20221123171712.png></a></p><footer class=footline><div><style>#comment{padding:8rem 0 2rem}#comment .vemoji{max-width:1.5em;max-height:1.5em}</style><div id=comment><script src=https://giscus.app/client.js data-repo=waouooo/discussions data-repo-id=R_kgDOI-EgHQ data-category=General data-category-id=DIC_kwDOI-EgHc4CUORS data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><noscript>Please enable JavaScript to view the comments powered by giscus.</noscript></div></footer></article></section></div></main></div><script src=../js/clipboard.min.js?1715187312 defer></script><script src=../js/perfect-scrollbar.min.js?1715187312 defer></script><script src=../js/featherlight.min.js?1715187312 defer></script><script src=../js/theme.js?1715187312 defer></script></body></html>